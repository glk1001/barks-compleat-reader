#: import ImageThemes barks_reader.ui.background_views.ImageThemes

#:set fun_options_border_margin_x dp(2)
#:set fun_options_border_margin_y dp(1)

<FunImageViewScreen>:
    pos_hint: {'x': 0, 'y': 0}
    size_hint: 1, 1
    opacity: 1 if root.is_visible else 0

    # Use a RelativeLayout to allow placing a button over the options box
    RelativeLayout:
        size_hint: 1, 1

        Image:
            color: root.image_color
            texture: root.image_texture
            fit_mode: root.image_fit_mode
            mipmap: True

            # Title info label
            BgColorLabel:
                text: "[i]" + root.current_title_str + "[/i]"
                sizing_factor_x: 1.07  # make background slightly longer than the title
                markup: True
                color: (1, 1, 0, 1)
                background_color: (0.1, 0.1, 0.1, 0.5 if root.current_title_str else 0)
                opacity: 0.8 if root.show_current_title else 0
                font_size: sp(15)
                size_hint: None, None
                size: self.texture_size
                # Position the label to the left of the goto_title_button.
                x: goto_title_button.x - self.width - dp(5)
                y: goto_title_button.y + goto_title_button.touch_padding

            # Goto title button
            TouchExpandedButton:
                id: goto_title_button

                # --- Pass Data ---
                source: str(sys_paths.get_up_arrow_file())
                visual_size: root.UP_ARROW_WIDTH
                is_active: root.goto_title_button_active

                # --- Positioning ---
                # Note: We subtract the padding so the *visual* icon stays in the exact
                # calculated spot, while the invisible button expands outwards.
                x: self.parent.x + self.parent.width - (1.4 * root.UP_ARROW_WIDTH) - self.touch_padding
                y: self.parent.y + (0.4 * root.UP_ARROW_WIDTH) - self.touch_padding

                on_press: root.on_goto_title()

        # --- Main container for the fun view image options menu ---
        BoxLayout:
            id: image_type_option_box
            orientation: 'vertical'
            size_hint: 0.5, 1
            pos_hint: {'x': 0.0, 'top': 1}
            # Indent this box
            padding: [dp(2 + fun_options_border_margin_x), dp(30), dp(2), dp(30)]
            spacing: dp(8)
            check_box_height: dp(25)
            opacity: 1 if root.fun_options_enabled else 0
            disabled: not root.fun_options_enabled

            canvas.before:
                # Add a rounded rectangle background box
                Color:
                    rgba: 0.05, 0.05, 0.05, 0.8
                RoundedRectangle:
                    pos: (self.x + fun_options_border_margin_x, self.y + fun_options_border_margin_y)
                    size: (self.width, self.height - (2 * fun_options_border_margin_y))
                    radius: [dp(10)]
                # Add a rounded rectangle border line
                Color:
                    rgba: 0.5, 0.5, 0.5, 1
                Line:
                    width: 1.5
                    rounded_rectangle:
                        (self.x + fun_options_border_margin_x, self.y + fun_options_border_margin_y,
                        self.width, self.height - (2 * fun_options_border_margin_y),
                        dp(10))

            # --- The options heading ---
            BgColorLabel:
                id: heading_label
                text: 'Select Bottom View Image Types'
                color: (1.0, 1.0, 0.0, 1)
                background_color: (0.1, 0.1, 0.1, 1)
                bold: True
                size_hint_y: None
                height: self.texture_size[1] + dp(12)  # Add vertical padding to height
                text_size: self.width, None
                halign: 'center'
                valign: 'middle'

            # --- 'All' Radio Button ---
            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: None
                height: image_type_option_box.check_box_height
                # Indent this box
                padding: [dp(30), 0, dp(30), 0]
                spacing: dp(10)

                CheckBox:
                    id: checkbox_all_image_types
                    group: "image_type_group"
                    size_hint_x: None
                    width: image_type_option_box.check_box_height
                    active: True
                Label:
                    text: 'All'
                    bold: True
                    text_size: self.size
                    halign: 'left'
                    valign: 'middle'

            # --- 'Custom' Radio Button ---
            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: None
                height: image_type_option_box.check_box_height
                # Indent this box
                padding: [dp(30), 0, dp(30), 0]
                spacing: dp(10)

                CheckBox:
                    id: checkbox_custom_image_types
                    group: "image_type_group"
                    size_hint_x: None
                    width: image_type_option_box.check_box_height
                Label:
                    text: 'Custom'
                    bold: True
                    text_size: self.size
                    halign: 'left'
                    valign: 'middle'

            # --- Indented Custom Options Box ---
            BoxLayout:
                id: custom_options_box
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                # Indent this box
                padding: [dp(30) + dp(40), 0, dp(30), 0]
                spacing: dp(10)
                disabled: not checkbox_custom_image_types.active

                CheckBoxRow:
                    id: check_box_ai_image_type
                    label_text: 'AI'
                    theme_enum: ImageThemes.AI
                CheckBoxRow:
                    id: check_box_bw_image_type
                    label_text: "Black and White"
                    theme_enum: ImageThemes.BLACK_AND_WHITE
                CheckBoxRow:
                    id: check_box_censorship_image_type
                    label_text: "Censorship"
                    theme_enum: ImageThemes.CENSORSHIP
                CheckBoxRow:
                    id: check_box_classics_image_type
                    label_text: "Classics"
                    theme_enum: ImageThemes.CLASSICS
                CheckBoxRow:
                    id: check_box_faves_image_type
                    label_text: 'Faves'
                    theme_enum: ImageThemes.FAVOURITES
                CheckBoxRow:
                    id: check_box_insets_image_type
                    label_text: "Insets"
                    theme_enum: ImageThemes.INSETS
                CheckBoxRow:
                    id: check_box_silhouettes_image_type
                    label_text: "Silhouettes"
                    theme_enum: ImageThemes.SILHOUETTES
                CheckBoxRow:
                    id: check_box_splash_image_type
                    label_text: 'Splash'
                    theme_enum: ImageThemes.SPLASHES
                CheckBoxRow:
                    id: check_box_40s_image_type
                    label_text: "40's"
                    theme_enum: ImageThemes.FORTIES
                CheckBoxRow:
                    id: check_box_50s_image_type
                    label_text: "50's"
                    theme_enum: ImageThemes.FIFTIES
                CheckBoxRow:
                    id: check_box_60s_image_type
                    label_text: "60's"
                    theme_enum: ImageThemes.SIXTIES

            # Spacer to stop BoxLayout centering the above widgets.
            Widget:

        Button:
            text: ''
            pos_hint:
                {'x': (0.5 - 0.025) if root.fun_options_enabled else 0.007, \
                'top': 0.986 if root.fun_options_enabled else 0.990}
            size_hint: None, None
            size: dp(15), dp(15)
            bold: True
            background_color: (0, 0, 0, 0) # Make default background transparent
            background_normal: ''
            canvas.before:
                Color:
                    rgba: (0.9, 0.1, 0.1, 1) if root.fun_options_enabled else (1, 1, 1, 1)
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [self.height / 2] # Make it a perfect circle

            on_press: root.fun_options_button_pressed()
            opacity: 1 if root.fun_options_enabled else 0.5

            Image:
                source:
                    str(sys_paths.get_barks_reader_close_icon_file()) \
                    if root.fun_options_enabled else \
                    str(sys_paths.get_hamburger_menu_icon_path())
                background_color: (0, 0, 0, 0) # Make default background transparent
                opacity: 1 if root.fun_options_enabled else 0.5
                x: self.parent.x + (0.05 * self.parent.width)
                y: self.parent.y + (0.05 * self.parent.height)
                size: (0.9 * self.parent.width, 0.9 * self.parent.height)
                fit_mode: "scale-down"
                mipmap: True

        Button:
            text: 'clear\nall'
            pos: checkbox_custom_image_types.x, custom_options_box.y + custom_options_box.height - self.height - dp(1)
            size_hint: None, None
            size: dp(35), dp(30)
            font_size: sp(10)
            bold: True
            text_size: self.size
            halign: 'center'
            valign: 'middle'
            background_color: (0, 0, 0, 0) # Make default background transparent
            background_normal: ''
            canvas.before:
                Color:
                    rgba: (0.0, 0.5, 0.5, 0.5) if self.state == 'normal' else (0.0, 0.1, 0.1, 1)
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [dp(5)]

            on_press: root.view_options_clear_all_button_pressed()
            opacity: 1 if root.fun_options_enabled else 0
            disabled: not checkbox_custom_image_types.active
