#:import Window kivy.core.window.Window

<IndexMenuButton>:
    # This rule defines the style for the '0', "'", and 'A'-'Z' menu buttons
    background_normal: ''
    background_down: ''
    border: (0, 0, 0, 0)
    background_color: app.index_theme.MENU_BG_SELECTED if self.is_selected else app.index_theme.MENU_BG
    font_size: fm.index_menu_font_size
    color: app.index_theme.MENU_TEXT
    bold: True
    canvas.after:
        Color:
            rgba: 0, 0, 0, 1
        Line:
            rectangle: self.x + dp(1), self.y + dp(1), self.width - dp(2), self.height - dp(2)
            width: dp(0.5)

<IndexItemButton>:
    # This rule defines the style for the index item buttons
    background_normal: ''
    background_down: ''
    border: (0, 0, 0, 0)
    background_color: app.index_theme.ITEM_BG
    font_name: ""  # filled in by constructor
    font_size: 0  # filled in by constructor
    color: app.index_theme.ITEM_TEXT
    size_hint: 1, None
    height: app.index_theme.ROW_HEIGHT
    padding: app.index_theme.INDEX_ITEM_LEFT_PAD, 0, 0, 0
    text_size: self.size
    halign: 'left'
    valign: 'middle'

<TitleShowSpeechButton>:
    background_normal: ''
    background_down: ''
    border: (0, 0, 0, 0)
    # Make the button's own background transparent.
    background_color: (0, 0, 0, 0)
    size_hint: None, None
    size: app.index_theme.ROW_HEIGHT, app.index_theme.ROW_HEIGHT
    padding: 0, 0, 0, 0

    Image:
        source: str(sys_paths.get_speech_bubble_icon_file())
        x: self.parent.x + dp(3)
        y: self.parent.y - (0.1 * ((1-0.7) * self.parent.height))
        size: 0.7 * self.parent.width, 0.7 * self.parent.height
        fit_mode: "contain"
        mipmap: True

#:set POPUP_BGND_COLOR [0, 0, 1, 0.3]  # Faint blue
#:set POPUP_BGND_COLOR_COVER [0, 0, 0.2, 1]  # Faint blue

<SpeechBubblesPopup@Popup>:
    background_color: POPUP_BGND_COLOR
    canvas.before:
        Color:
            rgba: self.background_color
        Rectangle:
            pos: self.pos
            size: self.size

<TextBoxWithTitleAndBorder@BoxLayout>:
    orientation: "vertical"
    padding: dp(10)
    spacing: dp(0)
    title: "Title Here"
    content: "Content Here"
    size_hint: None, None
    width: the_text_id.width + the_text_id.padding[0]
    height: title_id.height + the_text_id.height

    canvas.before:
        Color:
            rgba: 1, 0.1, 0.1, 1  # Border color
        Line:
            width: 2
            rounded_rectangle: (self.x, self.y, self.width, self.height, dp(10))

    Label:
        id: title_id
        text: root.title
        color: 1, 1, 0, 1
        bold: True
        padding: [dp(10), 0, dp(10), 0]
        halign: 'left'
        size_hint: None, None
        size: self.texture_size

        canvas.before:
            Color:
                rgba: POPUP_BGND_COLOR_COVER  # Match the popup background
            RoundedRectangle:
                pos: (self.x + 0.05*self.width, self.y + 0.05*self.height)
                size: (0.9*self.width, 0.9*self.height)
                radius: [dp(5)]

    Button:
        id: the_text_id
        text: root.content
        font_name: fm.speech_bubble_text_font_name
        font_size: fm.speech_bubble_text_font_size
        markup: True
        color: 0, 0, 0, 1
        background_normal: ''
        background_color: 1, 1, 1, 1
        padding: dp(20)
        multiline: True
        halign: 'left'
        valign: 'middle'
        size_hint: None, None
        size: self.texture_size

<IndexScreen>:
    opacity: 1 if root.is_visible else 0
    size_hint: (1, 1) if root.is_visible else (0, 0)

     # Have a white background for the whole screen
    canvas.before:
        Color:
            rgba: 1, 1, 1, 1
        Rectangle:
            pos: self.pos
            size: self.size

    Image:
        texture: root.image_texture
        size_hint: (1, 1)
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
        fit_mode: "cover"
        opacity: 0.253  # Control the underlay "lightness" here
        mipmap: True

    GridLayout:
        id: alphabet_side_layout
        cols: 1
        size_hint_x: None
        width: dp(40)
        pos_hint: {'x': 0, 'y': 0}
        padding: dp(0)
        spacing: dp(2)

    GridLayout:
        id: alphabet_top_split_layout
        cols: 20
        rows: 1
        col_default_width: dp(40)
        col_force_default: True
        row_default_height: dp(24)
        row_force_default: True
        pos: dp(45), 0
        padding: dp(0)
        spacing: dp(2)

    ScrollView:
        id: index_scroll_view

        do_scroll_x: False
        do_scroll_y: True
        always_overscroll: False
        effect_cls: "ScrollEffect"
        scroll_type: ["bars", "content"]

        bar_color: (0.5, 0.5, 0.8, 1)
        bar_inactive_color: (0.6, 0.6, 0.6, 1)
        bar_width: dp(12)

        size_hint: None, None
        size: root.width - alphabet_side_layout.width - dp(15), 0.91 * root.height
        pos_hint: {'right': 1, 'top': 0.95}

        FloatLayout:
            size_hint_y: None
            height: max(left_column_layout.height, middle_column_layout.height, right_column_layout.height)

            BoxLayout:
                id: left_column_layout
                orientation: 'vertical'
                size_hint: 1.0 / root.num_columns, None
                height: self.minimum_height
                pos_hint: {'x': 0, 'top': 1}
                padding: 0, 0, 0, dp(20)

            BoxLayout:
                id: middle_column_layout
                orientation: 'vertical'
                size_hint: (1.0 / root.num_columns) if root.num_columns >= 3 else 0, None
                height: self.minimum_height
                pos_hint: {'x': 1.0 / root.num_columns, 'top': 1}
                padding: 0, 0, 0, dp(20)
                opacity: 1 if root.num_columns >= 3 else 0
                disabled: root.num_columns < 3

            BoxLayout:
                id: right_column_layout
                orientation: 'vertical'
                size_hint: 1.0 / root.num_columns, None
                height: self.minimum_height
                pos_hint: {'right': 1, 'top': 1}
                padding: 0, 0, 0, dp(20)

    Label:
        pos_hint: {'right': 1 - 1.5*(root.UP_ARROW_WIDTH/Window.width), 'y': 0}
        padding: [0, 0, dp(8), dp(8)]
        text: "[i]" + root.current_title_str + "[/i]"
        markup: True
        color: (0, 0, 1, 1)
        opacity: 0.8
        font_size: sp(15)
        # Make the widget size itself to fit the text
        size_hint: None, None
        size: self.texture_size

    # Goto title button
    Button:
        id: goto_title_button
        text: ""
        opacity: 1 if root.current_title_str else 0
        disabled: not root.current_title_str
        background_color: (1, 1, 1, 0)
        background_normal: ""
        x: self.parent.x + self.parent.width - (1.4 * root.UP_ARROW_WIDTH)
        y: self.parent.y + (0.4 * root.UP_ARROW_WIDTH)
        size_hint: None, None
        size: (root.UP_ARROW_WIDTH, root.UP_ARROW_WIDTH)
        halign: "left"
        valign: "top"
        text_size: (self.width, self.height)
        on_press: root.on_goto_background_title()

        canvas.before:
            Color:
                rgba: .1, .1, .1, 1
            BoxShadow:
                inset: False
                pos: self.pos
                size: self.size
                offset: 0, 0
                spread_radius: 3.5, 3.5
                border_radius: 50, 50, 50, 50
                blur_radius: 2
        Image:
            source: str(sys_paths.get_up_arrow_file())
            color: (1, 1, 1, 1)
            y: self.parent.y
            x: self.parent.x
            size: self.parent.size
            fit_mode: "contain"
            mipmap: True
