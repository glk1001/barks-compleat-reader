<TreeViewScreen>:
    orientation: 'vertical'

    # Scroll view with top view image
    AnchorLayout:
        anchor_x: "left"
        anchor_y: "bottom"

        Label:
            opacity: 1 if root.main_files_not_loaded else 0
            text: root.main_files_not_loaded_msg
            multiline: True
            color: 1,0,0,1
            font_size: fm.error_main_view_font_size
            bold: True
            size_hint: 1, 1
            text_size: self.size
            halign: "center"
            valign: "middle"

        Image:
            color: root.top_view_image_color
            opacity: 0.3 if root.main_files_not_loaded else root.top_view_image_opacity
            texture: root.top_view_image_texture
            fit_mode: root.top_view_image_fit_mode
            mipmap: True

        BoxLayout:
            orientation: "vertical"

            # Vertical filler before scroll view.
            Widget:
                size_hint_y: 0.02

            ScrollView:
                id: scroll_view

                do_scroll_x: False
                do_scroll_y: True
                always_overscroll: False
                effect_cls: "ScrollEffect"
                scroll_type: ["bars", "content"]

                bar_color: (0.8, 0.8, 0.8, 1)
                bar_inactive_color: (0.8, 0.8, 0.8, 0.8)
                bar_width: dp(12)

                ReaderTreeView:
                    id: reader_tree_view
                    padding: dp(50)
                    indent_start: dp(50)
                    background_color: (0,1,0,1)
                    size_hint_y: None
                    height: self.minimum_height

        # Use a separate AnchorLayout to pin the button to the top-right corner
        # This is a sibling to the main content, so it's not affected by other layouts.
        AnchorLayout:
            anchor_x: 'right'
            anchor_y: 'top'
            padding: [0, dp(7), dp(10), 0]  # Add padding: [left, top, right, bottom]
 
            # Use a BoxLayout to group the label and button together.
            # The AnchorLayout will position this box, and the box will position its children.
            BoxLayout:
                orientation: 'horizontal'
                size_hint: None, None
                width: self.minimum_width  # Shrink-wrap the content
                height: goto_title_button.height
                spacing: dp(10)
 
                # Title info label
                Label:
                    text: "[i]" + root.current_title_str + "[/i]"
                    markup: True
                    color: (1, 1, 0, 1)
                    opacity: 0.3 if root.show_current_title else 0
                    font_size: sp(15)
                    size_hint: None, None
                    size: self.texture_size
 
                # Goto title button
                Button:
                    id: goto_title_button
                    text: ""
                    opacity: 0.8
                    background_color: (0, 0, 0, 0)
                    background_normal: ""
                    size_hint: None, None
                    size: (root.DOWN_ARROW_WIDTH, root.DOWN_ARROW_WIDTH)
                    on_press: root.on_goto_title()
 
                    canvas.before:
                        Color:
                            rgba: .1, .1, .1, 1
                        BoxShadow:
                            inset: False
                            pos: self.pos
                            size: self.size
                            offset: 0, 0
                            spread_radius: 3.5, 3.5
                            border_radius: [self.height / 2, self.height / 2, self.height / 2, self.height / 2]
                            blur_radius: 2
                    Image:
                        source: str(sys_paths.get_down_arrow_file())
                        color: (1, 1, 1, 1)
                        # Center the image on the button
                        center_x: self.parent.center_x
                        center_y: self.parent.center_y
                        size: self.parent.size
                        fit_mode: "contain"
                        mipmap: True
